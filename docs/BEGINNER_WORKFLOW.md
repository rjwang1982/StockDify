# 股票分析工作流-小白版 使用说明

## 📋 概述

这是一个基于 Dify 平台的智能股票分析工作流，专为投资小白设计。它不仅提供专业的技术分析报告，还会将复杂的金融术语转换为通俗易懂的语言，让零基础的投资者也能看懂股票分析。

**核心特点：**
- 💡 双层分析输出：专业版 + 小白版
- 📊 支持多市场：A股、港股、美股、ETF、LOF
- 🤖 AI 驱动：使用 DeepSeek 和 Moonshot Kimi 双模型
- 🔄 自动化流程：一键获取完整分析报告

---

## 🏗️ 工作流架构

### 整体流程图

```
开始 → 验证输入 → 获取股票数据 → 解析响应数据 → AI投资分析(专业版) → 小白版解读 → 输出结果
```

### 节点详解

#### 1️⃣ **开始节点 (start)**
- **功能**：接收用户输入
- **输入参数**：
  - `stock_code`：股票代码（默认：002352）
  - `market_type`：市场类型（A/HK/US/ETF/LOF）

#### 2️⃣ **验证输入 (validate)**
- **功能**：检查股票代码是否为空
- **逻辑**：
  - ✅ 不为空 → 继续流程
  - ❌ 为空 → 直接结束

#### 3️⃣ **获取股票数据 (http_request)**
- **功能**：调用后端 API 获取股票技术分析数据
- **配置**：
  - 请求方式：POST
  - API 地址：`http://192.168.132.2:8000/analyze-stock/`
  - 认证方式：Bearer Token（从环境变量 `apikey` 读取）
  - 重试机制：最多 3 次，间隔 100ms
  - 超时设置：连接 30s / 读取 60s / 写入 30s

**请求体示例：**
```json
{
  "stock_code": "002352",
  "market_type": "A"
}
```

#### 4️⃣ **解析响应数据 (parse_response)**
- **功能**：使用 Python 代码解析 API 返回的 JSON 数据
- **输出字段**：
  - `technical_summary`：技术指标概要（JSON 格式）
  - `report`：分析报告（JSON 格式）
  - `recent_data`：近 5 天交易数据（JSON 格式）
  - `stock_code`：股票代码
  - `price`：当前价格
  - `score`：综合评分
  - `recommendation`：系统建议

**代码逻辑：**
```python
# 提取关键数据
technical_summary = data.get("technical_summary", {})
report = data.get("report", {})
recent_data = data.get("recent_data", [])[:5]  # 只取最近5天

# 格式化为 JSON 字符串
return {
    "technical_summary": json.dumps(technical_summary, ensure_ascii=False, indent=2),
    "report": json.dumps(report, ensure_ascii=False, indent=2),
    "recent_data": json.dumps(recent_data, ensure_ascii=False, indent=2),
    ...
}
```

#### 5️⃣ **AI投资分析 (analyze_llm)** - 专业版
- **功能**：生成详细的专业投资分析报告
- **模型**：DeepSeek Chat
- **参数**：
  - Temperature: 0.7
  - Max Tokens: 2000

**分析内容包括：**
1. **趋势分析**
   - 当前趋势方向
   - 关键支撑位和压力位
   - 均线系统分析

2. **技术指标解读**
   - RSI 指标含义
   - MACD 信号分析
   - 成交量变化解读

3. **风险评估**
   - 波动率分析
   - 潜在风险点
   - 风险等级评定

4. **投资建议**
   - 短期操作策略（1-5天）
   - 中期目标价位（1-3个月）
   - 建议止损位
   - 仓位管理建议

5. **综合评分解读**
   - 当前评分说明
   - 系统建议依据

#### 6️⃣ **小白版解读 (simplify_llm)** - 通俗版
- **功能**：将专业分析转换为小白易懂的语言
- **模型**：Moonshot Kimi K2 Turbo Preview
- **参数**：
  - Temperature: 0.7
  - Max Tokens: 2000

**转换策略：**

1. **生活化比喻**
   - RSI 超买 → "商品太火爆，可能要降价了"
   - MACD 金叉 → "两条线交叉，发出买入信号"

2. **术语简化**
   - 支撑位 → 价格的"安全垫"
   - 压力位 → 价格的"天花板"
   - 均线 → 价格的"平均水平线"
   - 成交量 → "买卖的热闹程度"

3. **具体建议**
   - 使用"如果...那么..."句式
   - 给出明确的价格区间和操作时机

4. **风险提示**
   - 🟢 绿灯（低风险）
   - 🟡 黄灯（中等风险）
   - 🔴 红灯（高风险）

5. **输出结构**
   - 开头：一句话总结
   - 中间：3-5 个要点（带 emoji）
   - 结尾：明确的操作建议（买/卖/观望）

#### 7️⃣ **结束节点 (end)**
- **功能**：输出最终分析结果
- **输出变量**：
  - `stock_code`：股票代码
  - `current_price`：当前价格
  - `score`：综合评分
  - `recommendation`：系统建议
  - `professional_report`：专业版分析报告 ⭐
  - `simplified_report`：小白版解读报告 ⭐

---

## 🚀 使用方法

### 前置条件

1. **部署后端 API**
   - 确保股票分析 API 服务运行在 `http://192.168.132.2:8000`
   - API 需要支持 `/analyze-stock/` 端点

2. **配置环境变量**
   - 在 Dify 中设置环境变量 `apikey`
   - 默认值：`xue123`（建议修改为实际密钥）

3. **配置 AI 模型**
   - 确保已安装 DeepSeek 插件
   - 确保已安装 Moonshot 插件

### 运行步骤

1. **导入工作流**
   ```bash
   # 在 Dify 平台中导入 股票分析工作流-小白版.yml
   ```

2. **输入参数**
   - 股票代码：例如 `002352`（顺丰控股）
   - 市场类型：选择 `A`（A股）/ `HK`（港股）/ `US`（美股）/ `ETF` / `LOF`

3. **执行工作流**
   - 点击运行按钮
   - 等待约 30-60 秒（取决于 AI 模型响应速度）

4. **查看结果**
   - 先查看 `professional_report`：专业技术分析
   - 再查看 `simplified_report`：小白版通俗解读

---

## 📊 输出示例

### 专业版报告示例

```
## 股票 002352 投资分析报告

### 1. 趋势分析
- 当前趋势：短期上升趋势，中期震荡
- 支撑位：45.20 元（MA20）
- 压力位：52.80 元（前期高点）
- 均线系统：MA5 上穿 MA10，呈多头排列

### 2. 技术指标解读
- RSI(14)：68.5，接近超买区域
- MACD：金叉形成，DIF 线向上
- 成交量：较前期放大 30%，资金流入明显

### 3. 风险评估
- 波动率：中等（15%）
- 潜在风险：短期涨幅较大，存在回调压力
- 风险等级：中等

### 4. 投资建议
- 短期策略：逢低买入，目标价 52 元
- 中期目标：55-58 元区间
- 止损位：44 元
- 仓位建议：30-50%

### 5. 综合评分
- 评分：75 分
- 系统建议：适度买入
```

### 小白版报告示例

```
📊 这只股票现在处于上涨趋势，但涨得有点快了，要小心！

✅ **好消息**
股票价格最近在往上走，就像爬楼梯一样，一步一步往上。现在有很多人在买，买卖很热闹。

⚠️ **注意事项**
价格已经涨了不少，就像气球吹得太大，可能要歇一歇。如果跌到 44 元以下，就要赶紧卖掉止损。

💡 **我的建议**
如果你想买，可以等它稍微降一点再买，比如降到 46-47 元左右。如果已经买了，可以继续拿着，目标价 52 元左右。

🚦 **风险等级：黄灯**（中等风险）
最坏情况下可能会跌 10-15%，所以不要投入太多钱，建议用 30-50% 的资金。

🎯 **操作建议：适度买入**
```

---

## ⚙️ 配置说明

### 环境变量

| 变量名 | 说明 | 默认值 | 是否必填 |
|--------|------|--------|----------|
| `apikey` | API 认证密钥 | `xue123` | ✅ 是 |

### 模型配置

| 节点 | 模型 | 用途 | 参数 |
|------|------|------|------|
| AI投资分析 | DeepSeek Chat | 生成专业分析 | temp=0.7, max_tokens=2000 |
| 小白版解读 | Moonshot Kimi K2 | 转换通俗语言 | temp=0.7, max_tokens=2000 |

### API 配置

- **端点**：`http://192.168.132.2:8000/analyze-stock/`
- **方法**：POST
- **认证**：Bearer Token
- **超时**：连接 30s / 读取 60s / 写入 30s
- **重试**：3 次，间隔 100ms

---

## 🔧 故障排查

### 常见问题

#### 1. API 调用失败
**症状**：工作流卡在"获取股票数据"节点

**解决方案**：
- 检查 API 服务是否运行：`curl http://192.168.132.2:8000/health`
- 检查网络连接是否正常
- 验证 `apikey` 是否正确

#### 2. 解析数据失败
**症状**：输出显示"解析错误"

**解决方案**：
- 检查 API 返回的 JSON 格式是否正确
- 查看 API 日志，确认返回数据结构
- 验证股票代码是否有效

#### 3. AI 模型无响应
**症状**：工作流卡在 LLM 节点

**解决方案**：
- 检查 DeepSeek 和 Moonshot 插件是否正常
- 验证模型配额是否充足
- 尝试降低 `max_tokens` 参数

#### 4. 输出结果不完整
**症状**：只有专业版或小白版，缺少另一个

**解决方案**：
- 检查节点连接是否正确
- 确认两个 LLM 节点都已执行
- 查看 end 节点的输出配置

---

## 🎯 最佳实践

### 1. 参数调优

**Temperature 调整：**
- 专业分析：0.5-0.7（更严谨）
- 小白解读：0.7-0.9（更生动）

**Max Tokens 调整：**
- 简短分析：1000-1500
- 详细分析：2000-3000

### 2. 提示词优化

**专业版提示词建议：**
- 增加具体的技术指标阈值
- 添加历史数据对比
- 强调风险提示

**小白版提示词建议：**
- 增加更多生活化比喻
- 使用更多 emoji
- 简化句子结构

### 3. 性能优化

- 使用缓存减少重复 API 调用
- 并行处理多个股票分析
- 定时任务自动更新分析报告

---

## 📝 版本信息

- **版本**：0.4.0
- **创建日期**：2024
- **最后更新**：2024
- **兼容平台**：Dify Workflow

---

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

**改进方向：**
- 支持更多市场（如新加坡、日本股市）
- 增加基本面分析
- 添加历史回测功能
- 支持批量分析

---

## 📄 许可证

本项目仅供学习和研究使用，不构成投资建议。

**免责声明：**
- 股市有风险，投资需谨慎
- 本工具仅提供技术分析参考
- 投资决策请结合自身情况
- 不对投资损失承担责任

---

## 📞 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- Email: [your-email]
- 微信群：[群二维码]

---

**祝投资顺利！📈**
